name: ci/cd devops
on: 
  push:
    branches: [main]
  workflow_dispatch:
    branches: [main]
jobs: 
  build:
    runs-on: self-hosted  
    steps:
    - name: Checkout code 
      uses: actions/checkout@v3

    - name: Create .env file from secrets
      run: |
        Write-Host "Creating .env file from GitHub Secrets..."
        $envContent = @"
        DB_PORT="${{ secrets.DB_PORT }}"
        DB_NAME="${{ secrets.DB_NAME }}"
        DB_USER="${{ secrets.DB_USER }}"
        DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
        "@
        $envContent | Out-File -FilePath .env -Encoding UTF8
        Write-Host "âœ… .env file created successfully"
        Write-Host "Contents (masked):"
        Get-Content .env | ForEach-Object { $_ -replace '=.*', '=***' }  

    - name: Build and run containers  
      run: |
        docker compose -f Docker-compose.yaml up -d
        Start-Sleep -Seconds 30
        docker compose ps

    - name: "docker compose ps"
      run: docker compose ps   

    - name: Verify containers are running 
      run: | 
        $psOutput = docker compose ps
        if ($psOutput | Select-String -Quiet "Up") {
          Write-Host "âœ… All containers are running"
        } else {
          Write-Host "âŒ Some containers failed to start"
          docker compose logs
          exit 1
        }  # +1 Ð±Ð°Ð»Ð» (ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹ 2)
    - name: Save artifacts 
      uses: actions/upload-artifact@v4 
      with: 
        name: deployment-artifacts 
        path: | 
          .env 
          deployment-logs.txt 
        retention-days: 30  # +1 Ð±Ð°Ð»Ð» (ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹ 3) 
    - name: Save Docker logs 
      if: always() 
      run: | 
        echo "ðŸ“ Saving Docker logs..." 
        docker-compose logs > deployment-logs.txt 
        docker images > docker-images.txt 
        docker ps -a > docker-ps.txt 
    - name: Upload Docker logs as artifact 
      uses: actions/upload-artifact@v4 
      with: 
        name: docker-logs 
        path: | 
          deployment-logs.txt 
          docker-images.txt 
          docker-ps.txt 
        retention-days: 30 
    